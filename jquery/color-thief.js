var CanvasImage=function(image){this.imgEl=(image.jquery)?image[0]:image;this.canvas=document.createElement("canvas"),this.context=this.canvas.getContext("2d");document.body.appendChild(this.canvas);this.width=this.canvas.width=$(this.imgEl).width(),this.height=this.canvas.height=$(this.imgEl).height();this.context.drawImage(this.imgEl,0,0)};CanvasImage.prototype.clear=function(){this.context.clearRect(0,0,this.width,this.height)};CanvasImage.prototype.update=function(imageData){this.context.putImageData(imageData,0,0)};CanvasImage.prototype.getPixelCount=function(){return this.width*this.height};CanvasImage.prototype.getImageData=function(){return this.context.getImageData(0,0,this.width,this.height)};CanvasImage.prototype.removeCanvas=function(){$(this.canvas).remove()};function getDominantColor(sourceImage){var palette=[];var image=new CanvasImage(sourceImage),imageData=image.getImageData(),pixels=imageData.data,pixelCount=image.getPixelCount();var pixelArray=[];for(var i=0;i<pixelCount;i++){if(pixels[i*4+3]>=125){if(!(pixels[i*4]>250&&pixels[i*4+1]>250&&pixels[i*4+2]>250)){pixelArray.push([pixels[i*4],pixels[i*4+1],pixels[i*4+2]])}}}var cmap=MMCQ.quantize(pixelArray,5);var newPalette=cmap.palette();image.removeCanvas();return{r:newPalette[0][0],g:newPalette[0][1],b:newPalette[0][2]}}function createPalette(sourceImage,colorCount){var palette=[];var image=new CanvasImage(sourceImage),imageData=image.getImageData(),pixels=imageData.data,pixelCount=image.getPixelCount();var pixelArray=[];for(var i=0;i<pixelCount;i++){if(pixels[i*4+3]>=125){if(!(pixels[i*4]>250&&pixels[i*4+1]>250&&pixels[i*4+2]>250)){pixelArray.push([pixels[i*4],pixels[i*4+1],pixels[i*4+2]])}}}var cmap=MMCQ.quantize(pixelArray,colorCount);var newPalette=cmap.palette();image.removeCanvas();return newPalette}function getAverageRGB(sourceImage){var sampleSize=10;var image=new CanvasImage(sourceImage),imageData=image.getImageData(),pixels=imageData.data,pixelCount=image.getPixelCount();var i=0,count=0,rgb={r:0,g:0,b:0};while((i+=sampleSize*4)<pixelCount){if(pixels[i+3]>125){++count;rgb.r+=pixels[i];rgb.g+=pixels[i+1];rgb.b+=pixels[i+2]}}rgb.r=Math.floor(rgb.r/count);rgb.g=Math.floor(rgb.g/count);rgb.b=Math.floor(rgb.b/count);return rgb}function createAreaBasedPalette(sourceImage,colorCount){var palette=[];var image=new CanvasImage(sourceImage),imageData=image.getImageData(),pixels=imageData.data,pixelCount=image.getPixelCount();var rowCount=colCount=Math.round(Math.sqrt(colorCount)),colWidth=Math.round(image.width/colCount),rowHeight=Math.round(image.height/rowCount);var count=offset=rowOffset=vertOffset=horizOffset=0,rgb={r:0,g:0,b:0};for(var i=0;i<rowCount;i++){vertOffset=i*rowHeight*image.width*4;for(var j=0;j<colCount;j++){horizOffset=j*colWidth*4;for(var k=0;k<rowHeight;k++){rowOffset=k*image.width*4;for(var l=0;l<colWidth;l++){offset=vertOffset+horizOffset+rowOffset+(l*4);rgb.r+=pixels[offset];rgb.g+=pixels[offset+1];rgb.b+=pixels[offset+2];count++}}rgb.r=Math.floor(rgb.r/count);rgb.g=Math.floor(rgb.g/count);rgb.b=Math.floor(rgb.b/count);palette.push(rgb);rgb={r:0,g:0,b:0};count=0}}return palette};