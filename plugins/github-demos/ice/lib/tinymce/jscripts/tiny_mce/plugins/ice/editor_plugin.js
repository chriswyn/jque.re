(function(){tinymce.create("tinymce.plugins.IcePlugin",{deleteTag:"span",insertTag:"span",deleteClass:"del",insertClass:"ins",changeIdAttribute:"data-cid",userIdAttribute:"data-userid",userNameAttribute:"data-username",timeAttribute:"data-time",preserveOnPaste:"p",user:{name:"Unknown User",id:Math.random()},isTracking:true,contentEditable:true,css:"css/ice.css",manualInit:false,afterInit:function(){},afterClean:function(body){return body},beforePasteClean:function(body){return body},afterPasteClean:function(body){return body},init:function(ed,url){var self=this,changeEditor=null;ed.onPostRender.add(function(mgr){var dom=ed.dom;tinymce.extend(self,ed.getParam("ice"));self.insertSelector="."+self.insertClass;self.deleteSelector="."+self.deleteClass;ed.serializer.addRules(self.insertTag+"[id|class|title|"+self.changeIdAttribute+"|"+self.userIdAttribute+"|"+self.userNameAttribute+"|"+self.timeAttribute+"]");ed.serializer.addRules(self.deleteTag+"[id|class|title|"+self.changeIdAttribute+"|"+self.userIdAttribute+"|"+self.userNameAttribute+"|"+self.timeAttribute+"]");ed.serializer.addRules("tempdel[data-allocation]");dom.loadCSS(self.css.indexOf("://")>0?self.css:(url+"/"+self.css));var startIce=function(){if(!self.manualInit){ed.execCommand("initializeice")}};var script=document.createElement("script");script.type="text/javascript";if(script.readyState){script.onreadystatechange=function(){startIce()}}else{script.onload=startIce}script.src=url+"/js/ice.min.js";document.getElementsByTagName("head")[0].appendChild(script);ed.controlManager.setActive("ice_toggleshowchanges",true);if(self.isTracking){ed.controlManager.setActive("ice_togglechanges",true)}});ed.addCommand("initializeice",function(editor){ed=editor||ed;tinymce.DOM.win.setTimeout(function(){changeEditor=new ice.InlineChangeEditor({element:ed.getBody(),isTracking:self.isTracking,contentEditable:self.contentEditable,changeIdAttribute:self.changeIdAttribute,userIdAttribute:self.userIdAttribute,userNameAttribute:self.userNameAttribute,timeAttribute:self.timeAttribute,currentUser:{id:self.user.id,name:self.user.name},plugins:["IceEmdashPlugin","IceAddTitlePlugin","IceSmartQuotesPlugin",{name:"IceCopyPastePlugin",settings:{pasteType:"formattedClean",preserve:self.preserveOnPaste,beforePasteClean:self.beforePasteClean,afterPasteClean:self.afterPasteClean}}],changeTypes:{insertType:{tag:self.insertTag,alias:self.insertClass},deleteType:{tag:self.deleteTag,alias:self.deleteClass}}}).startTracking();ed.onEvent.add(function(ed,e){return changeEditor.handleEvent(e)});setTimeout(function(){self.afterInit.call(self)},10)},500)});ed.addCommand("ice_initenv",function(){changeEditor.initializeEnvironment();changeEditor.initializeRange()});ed.addCommand("icecleanbody",function(el){var body=changeEditor.getCleanContent(el||ed.getContent(),self.afterClean);return body});ed.addCommand("ice_hasDeletePlaceholders",function(){return changeEditor.isPlaceholdingDeletes});ed.addCommand("ice_addDeletePlaceholders",function(){return changeEditor.placeholdDeletes()});ed.addCommand("ice_removeDeletePlaceholders",function(){return changeEditor.revertDeletePlaceholders()});ed.addCommand("iceinsert",function(insert){insert=insert||{};changeEditor.insert(insert.item,insert.range)});ed.addCommand("icedelete",function(del){del=del||{};changeEditor.deleteContents(del.right,del.range)});ed.addCommand("ice_changeuser",function(user){changeEditor.setCurrentUser(user)});ed.addCommand("iceaccept",function(node){ed.undoManager.add();changeEditor.acceptChange(node||ed.selection.getNode());cleanup()});ed.addCommand("icereject",function(node){ed.undoManager.add();changeEditor.rejectChange(node||ed.selection.getNode());cleanup()});ed.addCommand("iceacceptall",function(){ed.undoManager.add();changeEditor.acceptAll();cleanup()});ed.addCommand("icerejectall",function(){ed.undoManager.add();changeEditor.rejectAll();cleanup()});ed.addCommand("ice_toggleshowchanges",function(){var body=ed.getBody(),cm=ed.controlManager,disabled=true;if(ed.dom.hasClass(body,"CT-hide")){cm.setActive("ice_toggleshowchanges",true);ed.dom.removeClass(body,"CT-hide");disabled=false}else{cm.setActive("ice_toggleshowchanges",false);ed.dom.addClass(body,"CT-hide")}tinymce.each(["iceacceptall","icerejectall"],function(button){cm.setDisabled(button,disabled)});ed.execCommand("mceRepaint")});ed.addCommand("ice_smartquotes",function(){var body=ed.getBody();changeEditor.pluginsManager.plugins.IceSmartQuotesPlugin.convert(body);ed.windowManager.alert("Regular quotes have been converted into smart quotes.")});ed.addCommand("ice_togglechanges",function(){if(changeEditor.isTracking){ed.execCommand("ice_disable")}else{ed.execCommand("ice_enable")}});ed.addCommand("ice_enable",function(){changeEditor.enableChangeTracking();ed.controlManager.setActive("ice_togglechanges",true);self.isTracking=true});ed.addCommand("ice_disable",function(){changeEditor.disableChangeTracking();ed.controlManager.setActive("ice_togglechanges",false);self.isTracking=false});ed.addCommand("ice_isTracking",function(){return changeEditor.isTracking?1:0});ed.addCommand("ice_strippaste",function(html){return changeEditor.pluginsManager.plugins.IceCopyPastePlugin.stripPaste(html)});ed.addCommand("ice_handlepaste",function(html){return changeEditor.pluginsManager.plugins.IceCopyPastePlugin.handlePaste()});ed.addButton("iceaccept",{title:"Accept Change",image:url+"/img/ice-accept-change.png",cmd:"iceaccept"});ed.addButton("icereject",{title:"Reject Change",image:url+"/img/ice-reject-change.png",cmd:"icereject"});ed.addButton("iceacceptall",{title:"Accept All Changes",image:url+"/img/ice-accept.png",cmd:"iceacceptall"});ed.addButton("icerejectall",{title:"Reject All Changes",image:url+"/img/ice-reject.png",cmd:"icerejectall"});ed.addButton("ice_toggleshowchanges",{title:"Show Track Changes",image:url+"/img/ice-showchanges.png",cmd:"ice_toggleshowchanges"});ed.addButton("ice_smartquotes",{title:"Convert quotes to smart quotes","class":"mce_blockquote",cmd:"ice_smartquotes"});ed.addButton("ice_togglechanges",{title:"Turn On Track Changes ",image:url+"/img/ice-togglechanges.png",cmd:"ice_togglechanges"});if(ed.plugins.contextmenu){ed.plugins.contextmenu.onContextMenu.add(function(th,menu,node){if(isInsideChangeTag(node)){menu.add({title:"<img src='"+url+"/img/ice-accept-change.png' style='vertical-align: middle;margin-left: -22px;margin-right: 5px;'>Accept Change",icon:"",cmd:"iceaccept"});menu.add({title:"<img src='"+url+"/img/ice-reject-change.png' style='vertical-align: middle;margin-left: -22px;margin-right: 5px;'>Reject Change",icon:"",cmd:"icereject"})}})}ed.onNodeChange.add(function(ed,cm,n){if(isInsideChangeTag(n)){cm.setDisabled("iceaccept",false);cm.setDisabled("icereject",false)}else{cm.setDisabled("iceaccept",true);cm.setDisabled("icereject",true)}cleanup()});function isInsideChangeTag(n){return !!ed.dom.getParent(n,self.insertSelector+","+self.deleteSelector)}function cleanup(){var empty=ed.dom.select(self.insertSelector+":empty,"+self.deleteSelector+":empty");ed.dom.remove(empty)}}});tinymce.PluginManager.add("ice",tinymce.plugins.IcePlugin)})();