(function(){var exports=this,ice=this.ice;var IceSmartQuotesPlugin=function(ice_instance){this._ice=ice_instance};IceSmartQuotesPlugin.prototype={convert:function(element){var self=this;ice.dom.each(element.getElementsByTagName(this._ice.blockEl),function(i,el){var deletes=[];try{self._ice.placeholdDeletes();self._convertBlock(el)}catch(e){console.error(e)}finally{self._ice.revertDeletePlaceholders()}})},_convertBlock:function(el){if(el.textContent.length<2){return}var single="'";var duble='"';var smartSingleLeft=String.fromCharCode(8216);var smartSingleRight=String.fromCharCode(8217);var smartDoubleLeft=String.fromCharCode(8220);var smartDoubleRight=String.fromCharCode(8221);var isDigit=function(c){return/\d/.test(c)};var isChar=function(c){return/\w/.test(c)};var isSpace=function(c){return c===String.fromCharCode(160)||c===String.fromCharCode(32)};var isNonSpace=function(c){return !isSpace(c)};var isDouble=function(c){return c===duble||c===smartDoubleLeft||c===smartDoubleRight};var isSingle=function(c){return c===single||c===smartSingleLeft||c===smartSingleRight};var range=this._ice.selection.createRange();var block=el.cloneNode(true);range.setStart(block,0);range.collapse(true);var charList=[],previous=null,current=null,next=null,pos=0;while(true){try{range.moveEnd("character",1);charList.push(range.cloneContents().textContent.charAt(pos++))}catch(e){break}}for(pos=0;pos<=charList.length;pos++){previous=current;current=next;next=charList.length===pos?null:charList[pos];switch(current){case smartSingleLeft:case smartSingleRight:this.replaceCharAtPosition(single,pos,el);case single:if((previous===null||isSpace(previous))&&(isDigit(next)&&isDigit(charList[pos+1])&&isSpace(charList[pos+2]))){this.replaceCharAtPosition(smartSingleRight,pos,el)}else{if(previous===null||(isSpace(previous)&&isNonSpace(next))){this.replaceCharAtPosition(smartSingleLeft,pos,el)}else{if(next===null||(isNonSpace(previous)&&isSpace(next))){this.replaceCharAtPosition(smartSingleRight,pos,el)}else{if(isChar(previous)&&isChar(next)){this.replaceCharAtPosition(smartSingleRight,pos,el)}}}}break;case smartDoubleLeft:case smartDoubleRight:this.replaceCharAtPosition(duble,pos,el);case duble:if(previous===null||(isSpace(previous)&&isNonSpace(next))){this.replaceCharAtPosition(smartDoubleLeft,pos,el)}else{if(next===null||(isNonSpace(previous)&&isSpace(next))){this.replaceCharAtPosition(smartDoubleRight,pos,el)}else{if((previous===null||isSpace(previous))&&(isSpace(next)&&isSingle(charList[pos+1]))){this.replaceCharAtPosition(smartDoubleLeft,pos,el)}else{if((next===null||isSpace(next))&&(isSpace(previous)&&isSingle(charList[pos-3]))){this.replaceCharAtPosition(smartDoubleRight,pos,el)}}}}break}}},replaceCharAtPosition:function(c,pos,el){var range=this._ice.selection.createRange();range.setStart(el,0);while(pos-->1){range.moveStart("character",1)}try{range.moveStart("character",1);range.moveStart("character",-1)}catch(e){}range.collapse(true);range.moveEnd("character",1);range.extractContents();this._ice.insert(c,range)}};ice.dom.noInclusionInherits(IceSmartQuotesPlugin,ice.IcePlugin);exports.ice._plugin.IceSmartQuotesPlugin=IceSmartQuotesPlugin}).call(this);