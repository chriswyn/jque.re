(function(){var exports=this,IceCopyPastePlugin;IceCopyPastePlugin=function(ice_instance){this._ice=ice_instance;this._tmpNode=null;this._tmpNodeTagName="icepaste";this._pasteId="icepastediv";var self=this;this.pasteType="formattedClean";this.preserve="p";this.beforePasteClean=function(body){return body};this.afterPasteClean=function(body){return body};ice_instance.element.oncopy=function(){return self.handleCopy.apply(self)};ice_instance.element.oncut=function(){return self.handleCut.apply(self)}};IceCopyPastePlugin.prototype={setSettings:function(settings){settings=settings||{};ice.dom.extend(this,settings);this.preserve+=","+this._tmpNodeTagName;this.setupPreserved()},keyDown:function(e){if(e.metaKey!==true&&e.ctrlKey!==true){return}if(e.keyCode==86){this.handlePaste()}},handleCut:function(){if(!this._ice.isTracking){return}var range=this._ice.getCurrentRange();if(range.collapsed){return}var html=range.cloneContents();var self=this;setTimeout(function(){self.doCut(html)},1);return true},doCut:function(html){var range=this._ice.getCurrentRange(),child,last;this._tmpNode=this._ice.env.document.createElement("span");range.insertNode(this._tmpNode);range.setStartAfter(this._tmpNode);range.collapse(true);while((child=html.firstChild)){range.insertNode(child);range.setStartAfter(child);range.collapse(true);last=child}range.setStartBefore(this._tmpNode);range.collapse(true);range.setEndAfter(last);this._ice.env.selection.addRange(range);this._ice.deleteContents(null,null,"cutType");ice.dom.remove(this._tmpNode)},handleCopy:function(e){},handlePaste:function(e){var range=this._ice.getCurrentRange();if(!range.collapsed){if(this._ice.isTracking){this._ice.deleteContents();range=range.cloneRange()}else{range.deleteContents();range.collapse(true)}}if(this._ice.isTracking){this._ice._moveRangeToValidTrackingPos(range)}if(range.startContainer==this._ice.element){var firstBlock=ice.dom.find(this._ice.element,this._ice.blockEl)[0];if(!firstBlock){firstBlock=ice.dom.create("<"+this._ice.blockEl+" ><br/></"+this._ice.blockEl+">");this._ice.element.appendChild(firstBlock)}range.setStart(firstBlock,0);range.collapse(true);this._ice.env.selection.addRange(range)}this._tmpNode=this._ice.env.document.createElement(this._tmpNodeTagName);range.insertNode(this._tmpNode);switch(this.pasteType){case"formatted":this.setupPaste();break;case"formattedClean":this.setupPaste(true);break}return true},setupPaste:function(stripTags){var div=this.createDiv(this._pasteId),self=this;div.focus();div.onpaste=function(){setTimeout(function(){self.handlePasteValue(stripTags)},1)};return true},handlePasteValue:function(stripTags){var html=ice.dom.getHtml(document.getElementById(this._pasteId));var childBlocks=ice.dom.children("<div>"+html+"</div>",this._ice.blockEl);if(childBlocks.length===1&&ice.dom.getNodeTextContent("<div>"+html+"</div>")===ice.dom.getNodeTextContent(childBlocks)){html=ice.dom.getHtml(html)}if(stripTags){html=this._ice.getCleanContent(html);html=this.stripPaste(html)}html=this.afterPasteClean.call(this,html);html=ice.dom.trim(html);var range=this._ice.getCurrentRange();range.setStartAfter(this._tmpNode);range.collapse(true);var newEl=null;var fragment=range.createContextualFragment(html);var changeid=this._ice.startBatchChange();if(ice.dom.hasBlockChildren(fragment)){var block=ice.dom.isChildOfTagName(this._tmpNode,this._ice.blockEl);range.setEndAfter(block.lastChild);this._ice.selection.addRange(range);var contents=range.extractContents();var newblock=this._ice.env.document.createElement(this._ice.blockEl);newblock.appendChild(contents);ice.dom.insertAfter(block,newblock);range.setStart(newblock,0);range.collapse(true);this._ice.selection.addRange(range);var prevBlock=range.startContainer;var innerBlock=null,newEl=null,lastEl=null;while(fragment.firstChild){if(fragment.firstChild.nodeType===3&&!jQuery.trim(fragment.firstChild.nodeValue)){fragment.removeChild(fragment.firstChild);continue}if(ice.dom.isBlockElement(fragment.firstChild)){if(fragment.firstChild.textContent!==""){innerBlock=null;var insert=null;if(this._ice.isTracking){insert=this._ice.createIceNode("insertType");this._ice.addChange("insertType",[insert]);newEl=document.createElement(fragment.firstChild.tagName);insert.innerHTML=fragment.firstChild.innerHTML;newEl.appendChild(insert)}else{insert=newEl=document.createElement(fragment.firstChild.tagName);newEl.innerHTML=fragment.firstChild.innerHTML}lastEl=insert;ice.dom.insertBefore(prevBlock,newEl)}fragment.removeChild(fragment.firstChild)}else{if(!innerBlock){newEl=document.createElement(this._ice.blockEl);ice.dom.insertBefore(prevBlock,newEl);if(this._ice.isTracking){innerBlock=this._ice.createIceNode("insertType");this._ice.addChange("insertType",[innerBlock]);newEl.appendChild(innerBlock)}else{innerBlock=newEl}}lastEl=innerBlock;innerBlock.appendChild(fragment.removeChild(fragment.firstChild))}}if(!newblock.textContent){newblock.parentNode.removeChild(newblock)}}else{if(this._ice.isTracking){newEl=this._ice.createIceNode("insertType",fragment);this._ice.addChange("insertType",[newEl]);range.insertNode(newEl);lastEl=newEl}else{var child;while((child=fragment.firstChild)){range.insertNode(child);range.setStartAfter(child);range.collapse(true);lastEl=child}}}this._ice.endBatchChange(changeid);this._cleanup(lastEl)},createDiv:function(id){var oldEl=ice.dom.getId(id);if(oldEl){ice.dom.empty(oldEl);return oldEl}var div=this._ice.env.document.createElement("div");div.id=id;div.setAttribute("contentEditable",true);ice.dom.setStyle(div,"width","1px");ice.dom.setStyle(div,"height","1px");ice.dom.setStyle(div,"overflow","hidden");ice.dom.setStyle(div,"position","fixed");ice.dom.setStyle(div,"top","10px");ice.dom.setStyle(div,"left","10px");document.body.appendChild(div);return div},handleCut:function(){this.cutElementId="icecut";this.cutElement=this.createDiv(this.cutElementId);var range=this._ice.getCurrentRange();if(range.collapsed){return}var html=range.getHTMLContents();if(this._ice.isTracking){this._ice.deleteContents()}else{range.deleteContents()}var crange=range.cloneRange();crange.collapse(true);this.cutElement.innerHTML=html;range.setStart(this.cutElement.firstChild,0);range.setEndAfter(this.cutElement.lastChild,this.cutElement.lastChild.length);var self=this;setTimeout(function(){range.setStart(crange.startContainer,crange.startOffset);range.collapse(true);self._ice.env.selection.addRange(range);ice.dom.remove(this.cutElement)},10)},stripPaste:function(content){content=this._cleanWordPaste(content);content=this.cleanPreserved(content);return content},setupPreserved:function(){var self=this;this._tags="";this._attributesMap=[];ice.dom.each(this.preserve.split(","),function(i,tagAttr){tagAttr.match(/(\w+)(\[(.+)\])?/);var tag=RegExp.$1;var attr=RegExp.$3;if(self._tags){self._tags+=","}self._tags+=tag.toLowerCase();self._attributesMap[tag]=attr.split("|")})},cleanPreserved:function(body){var self=this;var bodyel=this._ice.env.document.createElement("div");bodyel.innerHTML=body;bodyel=ice.dom.stripEnclosingTags(bodyel,this._tags);ice.dom.each(ice.dom.find(bodyel,this._tags),function(i,el){var tag=el.tagName.toLowerCase();var attrMatches=self._attributesMap[tag];if(attrMatches[0]&&attrMatches[0]==="*"){return true}if(el.hasAttributes()){var attributes=el.attributes;for(var i=attributes.length-1;i>=0;i--){if(!ice.dom.inArray(attributes[i].name,attrMatches)){el.removeAttribute(attributes[i].name)}}}});return bodyel.innerHTML},_cleanWordPaste:function(content){content=content.replace(/<(meta|link)[^>]+>/g,"");content=content.replace(/<!--(.|\s)*?-->/g,"");content=content.replace(/<style>[\s\S]*?<\/style>/g,"");content=content.replace(/<\/?\w+:[^>]*>/gi,"");content=content.replace(/<\\?\?xml[^>]*>/gi,"");content=this._cleanPaste(content);content=this._convertWordPasteList(content);content=content.replace(/<(\w[^>]*) (lang)=([^ |>]*)([^>]*)/gi,"<$1$4");content=content.replace(new RegExp('<(\\w[^>]*) style="([^"]*)"([^>]*)',"gi"),"<$1$3");return content},_getListType:function(elem,listTypes){var elContent=ice.dom.getHtml(elem);var info=null;ice.dom.foreach(listTypes,function(k){ice.dom.foreach(listTypes[k],function(j){ice.dom.foreach(listTypes[k][j],function(m){if((new RegExp(listTypes[k][j][m])).test(elContent)===true){info={html:elContent.replace(new RegExp(listTypes[k][j][m]),""),listType:k,listStyle:j};return false}});if(info!==null){return false}});if(info!==null){return false}});return info},_convertWordPasteList:function(content){var div=document.createElement("div");var ul=null;var prevMargin=null;var indentLvl={};var li=null;var newList=true;var listTypes={ul:{circle:["^o(s|&nbsp;)+"],disc:["^"+String.fromCharCode(183)+"(\\s|&nbsp;)+"],square:["^"+String.fromCharCode(167)+"(\\s|&nbsp;)+"],auto:["^"+String.fromCharCode(8226)+"(\\s|&nbsp;)+"]},ol:{decimal:["^\\d+\\.(s|&nbsp;)+"],"lower-roman":["^[ivxlcdm]+\\.(\\s|&nbsp;)+"],"upper-roman":["^[IVXLCDM]+\\.(\\s|&nbsp;)+"],"lower-alpha":["^[a-z]+\\.(\\s|&nbsp;)+"],"upper-alpha":["^[A-Z]+\\.(\\s|&nbsp;)+"]}};ice.dom.setHtml(div,content);var pElems=ice.dom.getTag("p",div);var pln=pElems.length;for(var i=0;i<pln;i++){var pEl=pElems[i];var listTypeInfo=this._getListType(pEl,listTypes);if(listTypeInfo!==null){var marginLeft=parseInt(ice.dom.getStyle(pEl,"margin-left"));var listType=listTypeInfo.listType;var listStyle=listTypeInfo.listStyle;ice.dom.setHtml(pEl,listTypeInfo.html);if(!listType){listType="ol"}if(newList){ul=document.createElement(listType);indentLvl={};ice.dom.attr(ul,"_icelistst","list-style-type:"+listStyle);indentLvl[marginLeft]=ul;ice.dom.insertBefore(pEl,ul)}else{if(marginLeft!==prevMargin){if(ice.dom.isset(indentLvl[marginLeft])===true){ul=indentLvl[marginLeft]}else{if(marginLeft>prevMargin){ul=document.createElement(listType);ice.dom.attr(ul,"_icelistst","list-style-type:"+listStyle);li.appendChild(ul);indentLvl[marginLeft]=ul}}}}li=this._createListItemFromElement(pEl);ul.appendChild(li);prevMargin=marginLeft;ice.dom.remove(pEl);newList=false}else{newList=true}}content=ice.dom.getHtml(div);return content},_createListItemFromElement:function(elem){var li=document.createElement("li");while(elem.firstChild){li.appendChild(elem.firstChild)}return li},_cleanPaste:function(content){content=content.replace(/<b(\s+|>)/g,"<strong$1");content=content.replace(/<\/b(\s+|>)/g,"</strong$1");content=content.replace(/<i(\s+|>)/g,"<em$1");content=content.replace(/<\/i(\s+|>)/g,"</em$1");return content},_cleanup:function(moveTo){try{moveTo=moveTo&&moveTo.lastChild||moveTo||this._tmpNode;var range=this._ice.getCurrentRange();range.setStart(moveTo,moveTo.length);range.collapse(true);this._ice.selection.addRange(range);if(this._ice.env.frame){this._ice.env.frame.contentWindow.focus()}else{this._ice.element.focus()}this._tmpNode.parentNode.removeChild(this._tmpNode);this._tmpNode=null;var ins=this._ice.env.document.getElementsByClassName(this._ice.changeTypes.insertType.alias);for(var i=0;i<ins.length;i++){if(!ins[i].textContent){if(ins[i].parentNode){ins[i].parentNode.removeChild(ins[i])}}}}catch(e){window.console&&console.error(e)}}};ice.dom.noInclusionInherits(IceCopyPastePlugin,ice.IcePlugin);exports._plugin.IceCopyPastePlugin=IceCopyPastePlugin}).call(this.ice);